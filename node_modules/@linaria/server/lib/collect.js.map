{"version":3,"file":"collect.js","names":["_postcss","_interopRequireDefault","require","obj","__esModule","default","escapeRegex","string","replace","extractClassesFromHtml","html","ignoredClasses","htmlClasses","regex","match","exec","ignoredClassesDeduped","Set","split","forEach","className","has","push","RegExp","join","collect","css","classnameModifiers","_classnameModifiers$i","_classnameModifiers$b","animations","other","postcss","root","critical","stylesheet","parse","blockedClasses","htmlClassesRegExp","blockedClassesSanitized","map","blockedClassesRegExp","isCritical","rule","selector","startsWith","isExcluded","length","test","Boolean","handleAtRule","name","criticalRule","clone","otherRule","removedNodesFromOther","each","childRule","index","_otherRule$nodes","nodes","remove","append","walkAtRules","_rule$parent","parent","type","walkedAtRules","walkRules","_rule$parent2","add","walkDecls","decl","value","params","toString"],"sources":["../src/collect.ts"],"sourcesContent":["import type { AtRule, ChildNode } from 'postcss';\nimport postcss from 'postcss';\n\ntype CollectResult = {\n  critical: string;\n  other: string;\n};\n\ninterface ClassnameModifiers {\n  blockedClasses?: string[];\n  ignoredClasses?: string[];\n}\n\n/**\n * Used to escape `RegExp`\n * [syntax characters](https://262.ecma-international.org/7.0/#sec-regular-expressions-patterns).\n */\nfunction escapeRegex(string: string) {\n  return string.replace(/[\\\\^$.*+?()[\\]{}|]/g, '\\\\$&');\n}\n\nconst extractClassesFromHtml = (\n  html: string,\n  ignoredClasses: string[]\n): RegExp => {\n  const htmlClasses: string[] = [];\n  const regex = /\\s+class=\"([^\"]+)\"/gm;\n  let match = regex.exec(html);\n  const ignoredClassesDeduped = new Set(ignoredClasses);\n\n  while (match !== null) {\n    match[1].split(' ').forEach((className) => {\n      // eslint-disable-next-line no-param-reassign\n      className = escapeRegex(className);\n      if (className !== '' && !ignoredClassesDeduped.has(className)) {\n        htmlClasses.push(className);\n      }\n    });\n    match = regex.exec(html);\n  }\n\n  return new RegExp(htmlClasses.join('|'), 'gm');\n};\n\n/**\n * This utility extracts critical CSS from given HTML and CSS file to be used in SSR environments\n * @param {string} html the HTML from which classes will be parsed\n * @param {string} css the CSS file from which selectors will be parsed and determined as critical or other\n * @param {string[]} ignoredClasses classes that, when present in the HTML, will not be included in the regular expression used to match selectors\n * @param {string[]} blockedClasses classes that, when contained in a selector, will cause the selector to be marked as not critical\n * @returns {CollectResult} object containing the critical and other CSS styles\n */\nexport default function collect(\n  html: string,\n  css: string,\n  classnameModifiers?: ClassnameModifiers\n): CollectResult {\n  const animations = new Set();\n  const other = postcss.root();\n  const critical = postcss.root();\n  const stylesheet = postcss.parse(css);\n  const ignoredClasses = classnameModifiers?.ignoredClasses ?? [];\n  const blockedClasses = classnameModifiers?.blockedClasses ?? [];\n\n  const htmlClassesRegExp = extractClassesFromHtml(html, ignoredClasses);\n  const blockedClassesSanitized = blockedClasses.map(escapeRegex);\n  const blockedClassesRegExp = new RegExp(\n    blockedClassesSanitized.join('|'),\n    'gm'\n  );\n\n  const isCritical = (rule: ChildNode) => {\n    // Only check class names selectors\n    if ('selector' in rule && rule.selector.startsWith('.')) {\n      const isExcluded =\n        blockedClasses.length > 0 && blockedClassesRegExp.test(rule.selector);\n      if (isExcluded) return false;\n\n      return Boolean(rule.selector.match(htmlClassesRegExp));\n    }\n\n    return true;\n  };\n\n  const handleAtRule = (rule: AtRule) => {\n    if (rule.name === 'keyframes') {\n      return;\n    }\n\n    const criticalRule = rule.clone();\n    const otherRule = rule.clone();\n\n    let removedNodesFromOther = 0;\n    criticalRule.each((childRule: ChildNode, index: number) => {\n      if (isCritical(childRule)) {\n        otherRule.nodes[index - removedNodesFromOther]?.remove();\n        removedNodesFromOther += 1;\n      } else {\n        childRule.remove();\n      }\n    });\n\n    rule.remove();\n\n    if (criticalRule.nodes.length > 0) {\n      critical.append(criticalRule);\n    }\n    if (otherRule.nodes.length > 0) {\n      other.append(otherRule);\n    }\n  };\n\n  stylesheet.walkAtRules('font-face', (rule) => {\n    /**\n     * @font-face rules may be defined also in CSS conditional groups (eg. @media)\n     * we want only handle those from top-level, rest will be handled in stylesheet.walkRules\n     */\n    if (rule.parent?.type === 'root') {\n      critical.append(rule);\n    }\n  });\n\n  const walkedAtRules = new Set();\n\n  stylesheet.walkRules((rule) => {\n    if (\n      rule.parent &&\n      'name' in rule.parent &&\n      (rule.parent as { name: string }).name === 'keyframes'\n    ) {\n      return;\n    }\n\n    if (rule.parent?.type === 'atrule') {\n      if (!walkedAtRules.has(rule.parent)) {\n        handleAtRule(rule.parent as AtRule);\n        walkedAtRules.add(rule.parent);\n      }\n      return;\n    }\n\n    if (isCritical(rule)) {\n      critical.append(rule);\n    } else {\n      other.append(rule);\n    }\n  });\n\n  critical.walkDecls(/animation/, (decl) => {\n    animations.add(decl.value.split(' ')[0]);\n  });\n\n  stylesheet.walkAtRules('keyframes', (rule) => {\n    if (animations.has(rule.params)) {\n      critical.append(rule);\n    }\n  });\n\n  return {\n    critical: critical.toString(),\n    other: other.toString(),\n  };\n}\n"],"mappings":"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"}